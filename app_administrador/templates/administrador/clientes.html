<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion de Clientes - Anticipo Express</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/estilos.css' %}"> 
</head>
<body>

<aside class="barra-lateral">
    <h2 class="logo">
        <span class="icono"></span>
        <span class="texto">Anticipo Express</span>
    </h2>

    <ul class="menu">
        <li><a href="{% url 'admin_inicio' %}">Inicio</a></li>
        <li><a href="{% url 'admin_clientes' %}" class="activo">Gestión de Clientes</a></li>
        <li><a href="{% url 'admin_productos' %}">Inventario y Productos</a></li>
        <li><a href="{% url 'admin_cuentas' %}">Cuentas por Cobrar</a></li>
        <li><a href="{% url 'admin_reportes' %}">Reportes de Ingreso</a></li>
    </ul>

    <a href="{% url 'inicio_login' %}" class="logout">Cerrar Sesión</a>
</aside>

<main class="contenido">
    <header class="encabezado">
        <h1>Gestión de Clientes</h1>
        <div class="usuario">
            <p>¡Hola, Administrador!</p>
            <div class="avatar">AD</div>
        </div>
    </header>

    <div class="contenedor-clientes">
        <div class="buscador">
            <input type="text" id="buscarCliente" placeholder="Buscar Cliente por nombre, teléfono, documento o correo...">
            <button class="btn-verde" id="btnAgregarCliente">Agregar Nuevo Cliente</button>
        </div>

        <p class="descripcion">Usa esta sección para gestionar los datos de los clientes</p>

        <table class="tabla-clientes">
            <thead>
                <tr>
                    <th>Nombre</th>
                    <th>Teléfono</th>
                    <th>Documento</th>
                    <th>Correo</th>
                    <th>Deuda Pendiente</th>
                    <th>Acciones</th>
                </tr>
            </thead>

            <tbody>
                {% for cliente in clientes %}
                <tr>
                    <td>{{ cliente.nombre }}</td>
                    <td>{{ cliente.telefono }}</td>
                    <td>{{ cliente.documento_identidad }}</td>
                    <td>{% if cliente.correo %}{{ cliente.correo }}{% else %}-{% endif %}</td>
                    <td class="{% if cliente.deuda_total > 0 %}rojo{% else %}verde{% endif %}">
                        ${{ cliente.deuda_total }} COP
                    </td>
                    <td>
                        <button class="btn-editar" 
                                onclick="abrirEditar('{{ cliente.id }}','{{ cliente.nombre }}','{{ cliente.telefono }}','{{ cliente.documento_identidad }}','{{ cliente.correo }}','{{ cliente.deuda_total }}')">
                                Editar
                        </button>
                        
                        {% if cliente.deuda_total == 0 %}
                            <button 
                                class="btn-saldada" 
                                disabled>
                                Saldada
                            </button>
                        {% else %}
                            <button 
                                class="btn-saldar" 
                                onclick="confirmarSaldar('{{ cliente.id }}', this)">
                                Marcar Saldada
                            </button>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</main>

<div class="modal-oscuro" id="modalAgregarCliente">
    <div class="modal-contenido">
        <h2>Nuevo Cliente</h2>

        <form method="POST" action="{% url 'agregar_cliente' %}">
            {% csrf_token %}
            
            <label>Nombre completo</label>
            <input type="text" name="nombre" required>

            <label>Teléfono</label>
            <input type="text" name="telefono" required>

            <label>Documento de Identidad</label>
            <input type="text" name="documento_identidad" required>

            <label>Correo (opcional)</label>
            <input type="email" name="correo">

            <label>Deuda inicial</label>
            <input type="number" name="deuda" min="0" value="0">

            <div class="acciones-modal">
                <button type="submit" class="btn-verde">Guardar Cliente</button>
                <button type="button" class="btn-cerrar" id="cerrarAgregar">Cancelar</button>
            </div>
        </form>
    </div>
</div>

<div class="modal-oscuro" id="modalEditar">
    <div class="modal-contenido">
        <h2>Editar Cliente</h2>

        <form method="POST" action="{% url 'editar_cliente' %}">
            {% csrf_token %}

            <input type="hidden" id="editar_id" name="id">

            <label>Nombre completo</label>
            <input type="text" id="editar_nombre" name="nombre" required>

            <label>Teléfono</label>
            <input type="text" id="editar_telefono" name="telefono" required>

            <label>Documento</label>
            <input type="text" id="editar_documento" name="documento_identidad" required>

            <label>Correo (opcional)</label>
            <input type="email" id="editar_correo" name="correo">

            <label>Deuda</label>
            <input type="number" id="editar_deuda" name="deuda" min="0">

            <div class="acciones-modal">
                <button type="submit" class="btn-morado">Guardar Cambios</button>
                <button type="button" class="btn-cerrar" onclick="cerrarEditar()">Cancelar</button>
            </div>
        </form>
    </div>
</div>

<div class="modal-oscuro" id="modalSaldar">
    <div class="modal-contenido">
        <h2>Confirmación</h2>
        <p>¿Seguro que quieres marcar como saldada esta persona?</p>

        <div class="acciones-modal">
            <button class="btn-verde" id="btnConfirmarSaldar">Sí, marcar</button>
            <button class="btn-cerrar" onclick="cerrarModalSaldar()">Cancelar</button>
        </div>
    </div>
</div>

<script>
// ----- Modal Agregar -----
const btnAgregar = document.getElementById("btnAgregarCliente");
const modalAgregar = document.getElementById("modalAgregarCliente");
const cerrarAgregar = document.getElementById("cerrarAgregar");

btnAgregar.onclick = () => modalAgregar.style.display = "flex";
cerrarAgregar.onclick = () => modalAgregar.style.display = "none";

// ----- Modal Editar -----
const modalEditar = document.getElementById("modalEditar");

function abrirEditar(id, nombre, telefono, documento, correo, deuda) {
    modalEditar.style.display = "flex";
    document.getElementById("editar_id").value = id;
    document.getElementById("editar_nombre").value = nombre;
    document.getElementById("editar_telefono").value = telefono;
    document.getElementById("editar_documento").value = documento;
    // Manejo de 'None' para campos opcionales
    document.getElementById("editar_correo").value = correo === "None" ? "" : correo;
    document.getElementById("editar_deuda").value = deuda;
}

function cerrarEditar() {
    modalEditar.style.display = "none";
}

// ====== BUSCADOR ======
document.getElementById("buscarCliente").addEventListener("keyup", function () {
    let filtro = this.value.toLowerCase();
    let filas = document.querySelectorAll(".tabla-clientes tbody tr");

    filas.forEach(fila => {
        // Asegúrate de que los índices de los hijos coincidan con tus columnas
        let nombre = fila.children[0].textContent.toLowerCase();
        let telefono = fila.children[1].textContent.toLowerCase();
        let documento = fila.children[2].textContent.toLowerCase();
        let correo = fila.children[3].textContent.toLowerCase();

        if (
            nombre.includes(filtro) ||
            telefono.includes(filtro) ||
            documento.includes(filtro) ||
            correo.includes(filtro)
        ) {
            fila.style.display = "";
        } else {
            fila.style.display = "none";
        }
    });
});

// ====== LÓGICA DEL MODAL SALDAR ======
let idClienteSeleccionado = null;
let botonSeleccionado = null; // Referencia al botón que se hizo clic

function confirmarSaldar(idCliente, boton) {
    idClienteSeleccionado = idCliente;
    botonSeleccionado = boton; // Guarda la referencia del botón
    document.getElementById("modalSaldar").style.display = "flex";
}

function cerrarModalSaldar() {
    document.getElementById("modalSaldar").style.display = "none";
}

document.getElementById("btnConfirmarSaldar").onclick = () => {
    // 1. Llama a tu endpoint de backend para marcar como saldada.
    // USAMOS LA FUNCIÓN URL DE DJANGO SI FUERA POSIBLE, PERO AQUÍ USAMOS LA RUTA MANUALMENTE CORREGIDA.
    const urlSaldar = `{% url 'marcar_saldada' 0 %}`.replace('0', idClienteSeleccionado);
    
    fetch(urlSaldar)
        .then(response => {
            if (response.ok) {
                // 2. Si el backend responde OK (código 200), actualiza el estado visual:
                
                // Cambia el texto
                botonSeleccionado.textContent = "Saldada";
                
                // Cambia las clases CSS (quitas btn-saldar y pones btn-saldada)
                botonSeleccionado.classList.remove("btn-saldar");
                botonSeleccionado.classList.add("btn-saldada");

                // Deshabilita el botón 
                botonSeleccionado.disabled = true;

                // 3. Actualiza la celda de la deuda:
                let fila = botonSeleccionado.closest("tr");
                let celdaDeuda = fila.children[4]; // La 5ta columna (índice 4) es la deuda

                celdaDeuda.textContent = "$0 COP";
                celdaDeuda.classList.remove("rojo");
                celdaDeuda.classList.add("verde");
                
                // Opcional: Mostrar un mensaje de éxito
                // alert("Deuda saldada con éxito.");

            } else {
                // Manejar error si el backend falla
                console.error("Error al marcar como saldada. Código:", response.status);
                alert("Hubo un error al intentar saldar la deuda. Inténtalo de nuevo.");
            }
        })
        .catch(error => {
            console.error("Error de red:", error);
            alert("Error de conexión. Inténtalo de nuevo.");
        });

    // 4. Cierra el modal, independientemente del resultado del fetch
    cerrarModalSaldar();
};
</script>

</body>
</html>